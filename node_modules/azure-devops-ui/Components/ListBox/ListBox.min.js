function overflowDetected(e){var t=e.querySelector(".text-ellipsis");return!!t&&t.scrollWidth>Math.ceil(t.offsetWidth)}import{__assign,__extends}from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./ListBox.css";import*as React from"react";import{ObservableLike}from"../../Core/Observable";import*as Utils_Accessibility from"../../Core/Util/Accessibility";import{format}from"../../Core/Util/String";import{Icon}from"../../Icon";import{renderListCell}from"../../List";import{ItemsObserver,Observer}from"../../Observer";import*as Resources from"../../Resources.Dropdown";import{Spinner,SpinnerSize}from"../../Spinner";import{ColumnSelect,renderEmptyCell,SimpleTableCell,Table,TableRow}from"../../Table";import{Tree,TreeRow}from"../../TreeEx";import{css}from"../../Util";import{DropdownSelection}from"../../Utilities/DropdownSelection";import{ArrayItemProvider,getItemsValue}from"../../Utilities/Provider";import{TreeItemProvider}from"../../Utilities/TreeItemProvider";import{ListBoxItemType}from"./ListBox.Props";export var DefaultListBoxWidth=-100;var ListBox=function(e){function t(t){var o=e.call(this,t)||this;o.tabbableIndex=-1,o.positions=[],o.count=0,o.table=React.createRef(),o.tree=React.createRef(),o.getItemWidth=function(){var e=o.props.width;return o.multiSelect&&e&&e>0?e-40:e},o.loadingChanged=function(){if(ObservableLike.getValue(o.props.loading))Utils_Accessibility.announce(Resources.AnnounceLoadingItems);else{Utils_Accessibility.announce(Resources.AnnounceFinishedLoadingItems);var e=o.props.items.length;Utils_Accessibility.announce(format(e>0?format(Resources.AnnounceItemCount,e):Resources.NoFilterResults),!0)}return!0},o.searchingChanged=function(){if(ObservableLike.getValue(o.props.searching))Utils_Accessibility.announce(Resources.Searching);else if(!1===ObservableLike.getValue(o.props.searching)){var e=o.props.items.length;Utils_Accessibility.announce(e>0?format(Resources.AnnounceFilterResultCount,e):Resources.NoFilterResults,!0)}return!0},o.onItemsChanged=function(){var e=getListBoxItemsValue(o.wrappedItems||o.props.items);o.tabbableIndex=-1,o.positions=[],o.count=0;for(var t=0,i=e;t<i.length;t++){var r=i[t],s=ObservableLike.getValue(r);s&&!listBoxItemSelectable(s)?o.positions.push(-1):(-1===o.tabbableIndex&&o.selection.selectable(o.positions.length)&&(o.tabbableIndex=o.positions.length),o.positions.push(++o.count))}return!0},o.onActivate=function(e,t){o.props.onActivate&&o.props.onActivate(e,t.data)},o.onSelect=function(e,t){o.props.onSelect&&o.props.onSelect(e,t.data)},o.onTreeActivate=function(e,t){var i=o.getListBoxItems();if(o.props.onActivate&&i){var r=t.data.underlyingItem,s=i.find(function(e){return e.id===r.id});s&&o.props.onActivate(e,s)}},o.onTreeSelect=function(e,t){var i=o.getListBoxItems();if(o.props.onSelect&&i){var r=t.data.underlyingItem,s=i.find(function(e){return e.id===r.id});s&&o.props.onSelect(e,s)}},o.renderListBoxRow=function(e,t,i){var r=o.props,s=r.excludeFocusZone,n=r.excludeTabStop,l=getListBoxItemsValue(o.wrappedItems||o.props.items),a=e>0&&l[e-1].type===ListBoxItemType.Header?"header-"+l[e-1].id:i.ariaDescribedBy,c=!s&&o.selection.selectable(e),p=__assign(__assign({tooltipProps:t.tooltipProps||{text:t.text,overflowOnly:!0,overflowDetected:overflowDetected}},i),{ariaDescribedBy:a,ariaPosInSet:o.positions[e]>=0?o.positions[e]:null,ariaSetSize:o.positions[e]>=0?o.count:null,excludeTabStop:n||o.tabbableIndex!==e,excludeFocusZone:!c,id:t.id,singleClickActivation:!1,role:t.type===ListBoxItemType.Header||t.type===ListBoxItemType.Divider?"row":"option"});return React.createElement(Observer,{key:t.id||e,item:t},function(){return React.createElement(TableRow,{key:t.id||e,index:e,details:p,className:css("bolt-list-box-row",t.type===ListBoxItemType.Header&&"bolt-list-box-header-row",t.type===ListBoxItemType.Divider&&"bolt-list-box-divider-row",t.type===ListBoxItemType.Loading&&"bolt-list-box-loading-row",o.multiSelect&&"bolt-list-box-multi-select-row",t.type!==ListBoxItemType.Header&&t.type!==ListBoxItemType.Divider&&"cursor-pointer",t.disabled&&"bolt-list-box-item-disabled")},o.columns.map(function(i,r){if(o.multiSelect&&0===r){if(t.type===ListBoxItemType.Divider||t.type===ListBoxItemType.Loading)return null;if(t.type===ListBoxItemType.Header)return renderEmptyCell(e,r)}return i.renderCell(e,r,i,t)}))})},o.renderListBoxTreeRow=function(e,t,i){var r=o.props,s=r.excludeFocusZone,n=r.excludeTabStop,l=!s&&o.selection.selectable(e),a=t.underlyingItem.data,c=__assign(__assign({tooltipProps:{text:t.underlyingItem.text,overflowOnly:!0,overflowDetected:overflowDetected}},i),{ariaPosInSet:o.positions[e]>=0?o.positions[e]:null,ariaSetSize:o.positions[e]>=0?o.count:null,excludeTabStop:n||o.tabbableIndex!==e,excludeFocusZone:!l,id:t.underlyingItem.id,singleClickActivation:!1,role:a.type===ListBoxItemType.Header||a.type===ListBoxItemType.Divider?"row":"option"});return React.createElement(Observer,{key:"observer-"+(t.underlyingItem.id||e),item:t},function(){return React.createElement(TreeRow,{key:"row-"+(t.underlyingItem.id||e),index:e,details:c,className:css("bolt-list-box-row",a.type===ListBoxItemType.Header&&"bolt-list-box-header-row",a.type===ListBoxItemType.Divider&&"bolt-list-box-divider-row",a.type===ListBoxItemType.Loading&&"bolt-list-box-loading-row",o.multiSelect&&"bolt-list-box-multi-select-row",a.type!==ListBoxItemType.Header&&a.type!==ListBoxItemType.Divider&&"cursor-pointer",a.disabled&&"bolt-list-box-item-disabled")},o.columns.map(function(o,i){return o.renderCell(e,i,o,t)}))})},o.renderListBoxCell=function(e,t,i,r){return renderListBoxCell(e,t,i,r,o.multiSelect)};var i=o.props,r=i.selection,s=i.renderItem,n=i.items;return o.selection=r||new DropdownSelection,o.multiSelect=!o.props.enforceSingleSelect&&!o.props.showTree&&o.selection.multiSelect,o.props.columns?o.columns=o.props.columns:(o.columns=[],o.multiSelect&&!1!==o.props.showChecksColumn?o.columns.push(new ColumnSelect):o.multiSelect||!0!==o.props.showChecksColumn||o.columns.push({id:"column-check",width:24,renderCell:function(e,t){return React.createElement(SimpleTableCell,{columnIndex:t,key:"column-check"},React.createElement(Icon,{className:css(!o.selection.selected(e)&&"invisible"),iconName:"CheckMark"}))},readonly:!0}),o.columns.push({id:"text",width:o.getItemWidth(),renderCell:s||o.renderListBoxCell,className:css("bolt-list-box-text",o.multiSelect?"bolt-list-box-text-multi-select":"bolt-list-box-text-single-select"),readonly:!0})),o.wrappedItems=wrapListBoxItems(n),o.onItemsChanged(),o}return __extends(t,e),t.prototype.componentDidUpdate=function(){this.props.didUpdate&&this.props.didUpdate()},t.prototype.render=function(){var e=this,t=this.props,o=t.ariaLabel,i=t.className,r=t.containerClassName,s=t.enforceSingleSelect,n=t.focuszoneProps,l=t.getUnselectableRanges,a=t.items,c=t.loading,p=t.searching,m=t.searchResultsLoadingText,d=t.showItemsWhileSearching,u=t.width,b={observableValue:a,filter:this.onItemsChanged},x=this.getListBoxItems(),g=x?this.props.showTree?new TreeItemProvider(convertListBoxItemsToTreeItems(x)):new ArrayItemProvider(x):a;return this.props.columns||(this.columns[this.columns.length-1].width=this.getItemWidth()),React.createElement(ItemsObserver,{getUnselectableRanges:l,items:a,selection:this.selection},React.createElement(Observer,{items:b,loading:{observableValue:c||!1,filter:this.loadingChanged},searching:{observableValue:p||!1,filter:this.searchingChanged}},function(t){if(t.searching&&!d)return React.createElement("div",{className:"bolt-list-box-loading",style:{width:u}},React.createElement(Spinner,{size:SpinnerSize.medium,label:m||Resources.Searching}));if(e.props.showTree){var l=g;return React.createElement(Tree,{ariaLabel:o||Resources.ListboxAriaLabel,className:css(i,"bolt-list-box"),columns:e.columns,containerClassName:r,focuszoneProps:n,itemProvider:l,onActivate:e.onTreeActivate,onSelect:e.onTreeSelect,onToggle:function(t,o){t.target.className.includes("bolt-tree-expand-button")&&(l.toggle(o.underlyingItem),e.props.onToggle&&e.props.onToggle(t,o.underlyingItem.data))},ref:e.tree,renderRow:e.renderListBoxTreeRow,role:"listbox",scrollable:!0,singleClickActivation:!1,selection:e.selection,showHeader:!1,showLines:!1})}return React.createElement(Table,{ariaLabel:o||Resources.ListboxAriaLabel,className:css(i,"bolt-list-box"),columns:e.columns,containerClassName:r,enforceSingleSelect:s,focuszoneProps:n,itemProvider:g,onActivate:e.onActivate,onSelect:e.onSelect,renderRow:e.renderListBoxRow,ref:e.table,role:"listbox",scrollable:!0,singleClickActivation:!1,selection:e.selection,showHeader:!1,showLines:!1,spacerWidth:0})}))},t.prototype.scrollIntoView=function(e,t){return this.table.current?this.table.current.scrollIntoView(e,t):this.tree.current?this.tree.current.scrollIntoView(e,t):void 0},t.prototype.getListBoxItems=function(){var e,t;return null!==(t=null!==(e=this.wrappedItems)&&void 0!==e?e:this.props.items&&(Array.isArray(this.props.items)?this.props.items:this.props.items.value))&&void 0!==t?t:void 0},t.defaultProps={getUnselectableRanges:getUnselectableRanges,width:DefaultListBoxWidth},t}(React.Component);export{ListBox};export function renderListBoxCell(e,t,o,i,r){return i.render?i.render(e,t,o,i):i.type===ListBoxItemType.Divider?React.createElement(SimpleTableCell,{className:css(o.className,i.className,r&&"bolt-list-box-divider-multi-select"),columnIndex:t,colspan:r?2:1,key:i.id,tableColumn:o},React.createElement("div",{className:"bolt-list-box-divider flex-grow"})):i.type===ListBoxItemType.Loading?React.createElement(LoadingCell,{columnIndex:t,key:i.id,tableColumn:o,tableItem:i}):React.createElement(SimpleTableCell,{className:css(o.className,i.className,i.type===ListBoxItemType.Header&&"bolt-list-box-header"),columnIndex:t,key:i.id,tableColumn:o},React.createElement("div",{id:i.type===ListBoxItemType.Header?"header-"+i.id:void 0,"aria-label":i.type===ListBoxItemType.Header?format(Resources.HeaderAriaLabel,i.text):void 0,className:"bolt-list-box-cell-container"},i&&renderListCell(i,!1)))};export function getUnselectableRanges(e,t){void 0===t&&(t=listBoxItemSelectable);for(var o=[],i=-1,r=0;r<e.length;r++)!t(e[r])&&i<0?i=r:t(e[r])&&i>=0&&(o.push({beginIndex:i,endIndex:r-1}),i=-1);return i>=0&&o.push({beginIndex:i,endIndex:e.length-1}),o};export function listBoxItemSelectable(e){return e.type!==ListBoxItemType.Header&&e.type!==ListBoxItemType.Divider&&e.type!==ListBoxItemType.Loading&&!e.disabled};export function wrapListBoxItems(e){if(Array.isArray(e)&&e.length&&"string"==typeof e[0])return e.map(function(e){return{id:e,text:e}})};export function convertListBoxItemsToTreeItems(e){for(var t=[],o=new Map,i=0,r=e;i<r.length;i++){var s=r[i],n=o.get(s.id),l={childItems:null===n||void 0===n?void 0:n.childItems,expanded:s.expanded,data:s,id:s.id,text:s.text};if(s.parent){var a=o.get(s.parent.id);a?a.childItems?a.childItems.push(l):a.childItems=[l]:o.set(s.parent.id,{childItems:[l]})}else t.push(l);o.set(l.id,l)}return t};export function getListBoxItemsValue(e){return getItemsValue(e)};var LoadingCell=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.componentDidMount=function(){this.props.onMount&&this.props.onMount()},t.prototype.render=function(){var e=this.props,t=e.columnIndex,o=e.tableColumn,i=e.tableItem;return React.createElement(SimpleTableCell,{className:css(o.className,i.className),columnIndex:t,colspan:2,contentClassName:"justify-center",key:t,tableColumn:o},React.createElement("div",{className:"bolt-list-box-loading"},React.createElement(Spinner,{size:SpinnerSize.medium,label:Resources.Loading})))},t}(React.Component);export{LoadingCell};export function isListBoxItemVisible(e){for(var t=e.parent;t;){if(!t.expanded)return!1;t=t.parent}return!0};