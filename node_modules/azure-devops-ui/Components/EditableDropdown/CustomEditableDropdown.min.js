import{__assign,__extends,__spreadArrays}from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./EditableDropdown.css";import*as React from"react";import{ObservableArray,ObservableLike,ObservableValue}from"../../Core/Observable";import{TimerManagement}from"../../Core/TimerManagement";import{equals,startsWith}from"../../Core/Util/String";import{Dropdown,DropdownCallout,DropdownExpandableTextField,filterItems}from"../../Dropdown";import{isListBoxItemVisible,renderListBoxCell}from"../../ListBox";import{Observer}from"../../Observer";import*as Resources from"../../Resources.Dropdown";import{css,KeyCode}from"../../Util";import{DropdownSelection}from"../../Utilities/DropdownSelection";import{EditableDropdownItemProvider}from"../../Utilities/EditableDropdownItemProvider";import{filterTreeItems,renderHighlightedText}from"../Dropdown/Dropdown";var CustomEditableDropdown=function(e){function t(t){var r=e.call(this,t)||this;return r.dropdown=React.createRef(),r.listBox=React.createRef(),r.filteredIndexMap=new ObservableValue([]),r.filterMatches=[],r.collapse=function(){r.dropdown.current&&r.dropdown.current.collapse()},r.expand=function(){r.dropdown.current&&r.dropdown.current.expand()},r.renderItem=function(e,t,o,n){return r.wrapWithFocusedIndexObserver(e,t,o,n,function(e,t,o,n){var s=n,i=o,l=r.filterMatches[e];return!s.render&&l&&l.length&&(s.render=function(e,t,r,o){return renderHighlightedText(e,t,r,o,l)}),r.props.renderItem(e,t,i,s)})},r.wrapWithFocusedIndexObserver=function(e,t,o,n,s){return React.createElement(Observer,{focusedIndex:{observableValue:r.focusedIndex,filter:function(){var t=r.filteredIndexMap.value[e];return t===r.focusedIndex.value||t===r.previousFocusedIndex}},key:"focused-observer-"+e+"-"+t},function(){var i=r.filteredIndexMap.value[e]===r.focusedIndex.value?__assign(__assign({},n),{className:css(n.className,"bolt-editable-dropdown-focused-item")}):__assign({},n);return s(e,t,o,i)})},r.onCollapse=function(){var e=r.props,t=e.allowFreeform,o=e.autoAccept,n=e.onCollapse,s=e.onTextChange,i=e.onValueChange,l=e.showTree,a=e.text;if(n&&n(),!r.selectedItemInList){var d=r.itemProvider.value.findIndex(function(e,t){return r.selection.selectable(t)&&e.text===ObservableLike.getValue(a||"")});d>-1&&r.selectIndex(d)}var u=r.itemProvider.length-1;if(!t||r.selection.value.length&&r.selection.value[0].beginIndex!==u&&r.selectedItemInList||!r.itemProvider.hasExtraItem){if(l&&r.lastSelectedItem)i&&i(r.lastSelectedItem);else if(r.selection.value.length){var c=r.itemProvider.value[r.selection.value[0].beginIndex];i&&i(c)}}else{if(o||r.selectedItemInList||r.selectedFreeform){var p=r.itemProvider.value[u].id;i&&i({id:p,text:p})}r.selectedFreeform=!1,r.selection.clear()}s&&s(null,""),r.isExpanded=!1,r.selectedItemInList=!1,r.lastSelectedItem=void 0,l&&(r.focusedIndex.value=-1)},r.onItemsChange=function(e,t){"change"!==t&&r.filterItems(),r.selectSelectedTextItem()},r.selectSelectedTextItem=function(){if(r.props.selectedText){var e=ObservableLike.getValue(r.props.selectedText);if(e){var t=r.itemProvider.value.findIndex(function(t){return t.text===e});t>-1&&r.selection.select(t)}}},r.onSelect=function(e,t){r.selectedItemInList=!0,r.lastSelectedItem=t},r.renderExpandable=function(e){return React.createElement(Observer,{focusedIndex:r.focusedIndex,selectedText:r.props.selectedText,text:r.props.text},function(t){var o,n=r.props,s=n.allowTextSelection,i=n.onTextChange,l=t.focusedIndex,a=t.selectedText,d=t.text;l>-1&&r.itemProvider.value[l]&&(o=r.itemProvider.value[l].id);var u=s&&a&&!r.isExpanded?a:d,c=__assign(__assign({},e),{ariaActiveDescendant:o,editable:!0,showPrefix:!d,blurDismiss:!0,onChange:i,onKeyDown:r.onKeyDown,value:u});return r.props.renderExpandable(c)})},r.renderCallout=function(e){var t=__assign(__assign({},e),{focusOnMount:!1,excludeTabStop:!0,excludeFocusZone:!0,ignoreMouseDown:!0,listBoxRef:r.listBox});return r.props.renderCallout(t)},r.onExpand=function(){if(r.props.onExpand&&r.props.onExpand(),r.props.filterItems){var e=r.props.filterItems("",r.itemProvider.value),t=r.updateFilteredIndexMap(e.filteredIndexMap);r.filteredItems.value=e.filteredItems,r.focusItem(t)}else{r.filteredItems.value=r.itemProvider.value;var o=r.updateFilteredIndexMap(r.filteredItems.value.map(function(e,t){return t}));r.focusItem(o)}r.isExpanded=!0},r.onValueChange=function(){var e=ObservableLike.getValue(r.props.text||"");return r.props.allowFreeform&&(r.itemProvider.hasExtraItem&&r.filteredItems.pop(),r.itemProvider.setTextValue(e)),r.isExpanded&&r.filterItems(),!1},r.filterItems=function(){var e,t,o=r.itemProvider.value,n=ObservableLike.getValue(r.props.text||"");if(r.props.filterItems)e=r.props.filterItems(n,o);else if(n)if(r.props.showTree){var s=filterTreeItems(o,n,[],r.props.filterItem,r.props.filterMatchedItem);e=s[0],t=s[1]}else e=filterItems(o,n,[],r.props.filterItem),(t=o.findIndex(function(e){var t;return equals(null!==(t=e.text)&&void 0!==t?t:"",n,!0)}))<0&&(t=o.findIndex(function(e){var t;return startsWith(null!==(t=e.text)&&void 0!==t?t:"",n,!0)}));else e={filteredItems:o,filteredIndexMap:o.map(function(e,t){return t}),filterMatches:[]};r.filterMatches=e.filterMatches;var i=r.updateFilteredIndexMap(e.filteredIndexMap);r.filteredItems.value=e.filteredItems;var l=t&&t>-1?t:i;r.focusItem(l)},r.onKeyDown=function(e){var t=e.which,o=r.isExpanded;switch(t){case KeyCode.escape:r.collapse(),e.preventDefault();break;case KeyCode.enter:r.isExpanded||(r.expand(),e.preventDefault());case KeyCode.tab:if(o&&!e.shiftKey&&(r.filteredItems.length||r.props.allowFreeform)){(n=r.getFocusedIndex())>=0?r.selectIndex(n):r.selectedFreeform=!0,r.collapse(),e.preventDefault()}break;case KeyCode.upArrow:r.isExpanded&&(r.focusPreviousItem(),r.listBox.current&&r.listBox.current.scrollIntoView(r.filteredIndexMap.value.indexOf(r.focusedIndex.value),{block:"nearest"})),e.preventDefault();break;case KeyCode.rightArrow:if(r.isExpanded&&r.props.showTree){n=r.getFocusedIndex();(s=r.itemProvider.value[n]).expanded||(r.props.onToggle&&r.props.onToggle(e,s),r.focusNextItem(),r.focusPreviousItem(),r.listBox.current&&r.listBox.current.scrollIntoView(r.filteredIndexMap.value.indexOf(n),{block:"nearest"}))}break;case KeyCode.downArrow:r.isExpanded?(r.focusNextItem(),r.listBox.current&&r.listBox.current.scrollIntoView(r.filteredIndexMap.value.indexOf(r.focusedIndex.value),{block:"nearest"})):r.isExpanded||r.expand(),e.preventDefault();break;case KeyCode.leftArrow:if(r.isExpanded&&r.props.showTree){var n=r.getFocusedIndex(),s=r.itemProvider.value[n];s.expanded&&(r.props.onToggle&&r.props.onToggle(e,s),r.focusPreviousItem(),r.focusNextItem(),r.listBox.current&&r.listBox.current.scrollIntoView(r.filteredIndexMap.value.indexOf(n),{block:"nearest"}))}break;case KeyCode.delete:case KeyCode.backspace:r.props.allowClear&&!ObservableLike.getValue(r.props.text||"")?(r.selection.clear(),r.props.onValueChange&&r.props.onValueChange()):r.expand();break;default:r.expand()}},r.selection=t.selection||new DropdownSelection,r.itemProvider=new EditableDropdownItemProvider(t.items,r.selection),r.filteredItems=new ObservableArray(__spreadArrays(r.itemProvider.value)),r.focusedIndex=new ObservableValue(-1),r.previousFocusedIndex=-1,r.timerManagement=new TimerManagement,r.filteredIndexMap.value=r.itemProvider.value.map(function(e,t){return t}),r.selectSelectedTextItem(),r.props.columns&&(r.columns=r.props.columns.map(function(e){return __assign(__assign({},e),{renderCell:function(t,o,n,s){return r.wrapWithFocusedIndexObserver(t,o,n,s,e.renderCell)}})})),r}return __extends(t,e),t.prototype.render=function(){var e=this,t=this.props,r=t.actions,o=t.allowTextSelection,n=t.ariaLabel,s=t.calloutContentClassName,i=t.className,l=t.disabled,a=t.filterByText,d=t.getUnselectableRanges,u=t.noItemsText,c=t.onToggle,p=t.selectedText,f=t.showTree,x=t.text,m=t.minCalloutWidth;return React.createElement(Observer,{text:{observableValue:x,filter:this.onValueChange},items:{observableValue:this.itemProvider,filter:this.onItemsChange},selection:this.selection,selectedText:p},function(t){var p=e.props.placeholder;if(!o)if(t.selectedText)p=t.selectedText;else if(t.selection.length){var x=t.selection[0].beginIndex;x>-1&&(p=e.itemProvider.value[x].text)}return React.createElement(Dropdown,{actions:r,ariaLabel:n,calloutContentClassName:s,className:css("bolt-editable-dropdown",(t.selection.length>0||!!t.selectedText)&&"bolt-editable-dropdown-with-selection",i),columns:e.columns,disabled:l,getUnselectableRanges:d,filterByText:a,items:e.itemProvider,noItemsText:u||Resources.NoItemsFound,onCollapse:e.onCollapse,onExpand:e.onExpand,onSelect:e.onSelect,onToggle:c,placeholder:p,ref:e.dropdown,renderCallout:e.renderCallout,renderExpandable:e.renderExpandable,renderItem:e.renderItem,selection:e.selection,showFilterBox:!1,showTree:f,userFilteredItems:e.filteredItems,userFilteredItemsIndexMap:e.filteredIndexMap,minCalloutWidth:m})})},t.prototype.componentDidMount=function(){this.props.filterThrottleWait&&(this.filterItems=this.timerManagement.debounce(this.filterItems,this.props.filterThrottleWait))},t.prototype.focus=function(){this.dropdown.current&&this.dropdown.current.focus()},t.prototype.selectIndex=function(e){e>-1&&(this.selection.select(e),this.selectedItemInList=!0)},t.prototype.focusItem=function(e){void 0!==e&&e>-1&&this.isFocusable(e)&&(this.previousFocusedIndex=this.focusedIndex.value,this.focusedIndex.value=e)},t.prototype.updateFilteredIndexMap=function(e){var t=this,r=this.filteredIndexMap.value.indexOf(this.focusedIndex.value);this.filteredIndexMap.value=e;var o=e[r];return(!o||o<0||!this.selection.selectable(o)||-1===this.filteredIndexMap.value.indexOf(o))&&(o=this.props.showTree?-1:this.filteredIndexMap.value.find(function(e){return t.selection.selectable(e)})),o},t.prototype.focusNextItem=function(){for(var e,t=this.filteredIndexMap.value.indexOf(this.focusedIndex.value)+1;t<this.filteredIndexMap.value.length;t++)if(this.selection.selectable(this.filteredIndexMap.value[t])){e=this.filteredIndexMap.value[t];break}this.focusItem(e)},t.prototype.focusPreviousItem=function(){for(var e,t=this.filteredIndexMap.value.indexOf(this.focusedIndex.value)-1;t>=0;t--)if(this.selection.selectable(this.filteredIndexMap.value[t])){e=this.filteredIndexMap.value[t];break}this.focusItem(e)},t.prototype.getFocusedIndex=function(){if(!this.props.showTree)return this.focusedIndex.value;for(var e=this.focusedIndex.value,t=0;t<e;t++)isListBoxItemVisible(this.itemProvider.value[t])||e++;return e},t.prototype.isFocusable=function(e){if(!this.props.showTree)return!0;return e<this.itemProvider.value.filter(function(e){return isListBoxItemVisible(e)}).length},t.defaultProps={allowClear:!0,autoAccept:!0,renderExpandable:DropdownExpandableTextField,renderCallout:DropdownCallout,renderItem:renderListBoxCell},t}(React.Component);export{CustomEditableDropdown};